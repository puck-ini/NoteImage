<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis 内存模型 | zchzh的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="怎么还有😇">
    
    <link rel="preload" href="/blog/assets/css/0.styles.dcea0daa.css" as="style"><link rel="preload" href="/blog/assets/js/app.9d120f23.js" as="script"><link rel="preload" href="/blog/assets/js/2.0274c0be.js" as="script"><link rel="preload" href="/blog/assets/js/24.806fb0cd.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.06624a3b.js"><link rel="prefetch" href="/blog/assets/js/11.5e5b0273.js"><link rel="prefetch" href="/blog/assets/js/12.ea7d3a67.js"><link rel="prefetch" href="/blog/assets/js/13.4be6cb33.js"><link rel="prefetch" href="/blog/assets/js/14.6101831f.js"><link rel="prefetch" href="/blog/assets/js/15.8755b1f4.js"><link rel="prefetch" href="/blog/assets/js/16.2f38dc7c.js"><link rel="prefetch" href="/blog/assets/js/17.c794ab21.js"><link rel="prefetch" href="/blog/assets/js/18.f69a8835.js"><link rel="prefetch" href="/blog/assets/js/19.86ab391a.js"><link rel="prefetch" href="/blog/assets/js/20.551eeb64.js"><link rel="prefetch" href="/blog/assets/js/21.a0bd5987.js"><link rel="prefetch" href="/blog/assets/js/22.6f38acc6.js"><link rel="prefetch" href="/blog/assets/js/23.2d8c24fe.js"><link rel="prefetch" href="/blog/assets/js/25.b5811df0.js"><link rel="prefetch" href="/blog/assets/js/26.d0141def.js"><link rel="prefetch" href="/blog/assets/js/27.8a6b0382.js"><link rel="prefetch" href="/blog/assets/js/28.b541235e.js"><link rel="prefetch" href="/blog/assets/js/29.b9bc112a.js"><link rel="prefetch" href="/blog/assets/js/3.3619f8a3.js"><link rel="prefetch" href="/blog/assets/js/30.bab6c6d8.js"><link rel="prefetch" href="/blog/assets/js/31.a5f350c4.js"><link rel="prefetch" href="/blog/assets/js/32.b6586786.js"><link rel="prefetch" href="/blog/assets/js/33.1af31bee.js"><link rel="prefetch" href="/blog/assets/js/34.ed7bb111.js"><link rel="prefetch" href="/blog/assets/js/35.7081f8ba.js"><link rel="prefetch" href="/blog/assets/js/36.881d672a.js"><link rel="prefetch" href="/blog/assets/js/37.aff888c2.js"><link rel="prefetch" href="/blog/assets/js/38.b5266363.js"><link rel="prefetch" href="/blog/assets/js/39.ed4124cf.js"><link rel="prefetch" href="/blog/assets/js/4.6b53442f.js"><link rel="prefetch" href="/blog/assets/js/40.7bef4fda.js"><link rel="prefetch" href="/blog/assets/js/41.147e41bc.js"><link rel="prefetch" href="/blog/assets/js/42.c335146e.js"><link rel="prefetch" href="/blog/assets/js/43.2bf3a732.js"><link rel="prefetch" href="/blog/assets/js/5.5cb292f8.js"><link rel="prefetch" href="/blog/assets/js/6.a012196c.js"><link rel="prefetch" href="/blog/assets/js/7.03fa16f6.js"><link rel="prefetch" href="/blog/assets/js/8.d3387bae.js"><link rel="prefetch" href="/blog/assets/js/9.0ec4fc49.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.dcea0daa.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">zchzh的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/note/" class="nav-link router-link-active">
  笔记
</a></div><div class="nav-item"><a href="/blog/interview/" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="/blog/other/" class="nav-link">
  其他
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/puck-ini" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://puck-ini.github.io/blog/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/note/" class="nav-link router-link-active">
  笔记
</a></div><div class="nav-item"><a href="/blog/interview/" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="/blog/other/" class="nav-link">
  其他
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/puck-ini" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://puck-ini.github.io/blog/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>java笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>springboot</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>redis笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/note/redis/redis.html" class="sidebar-link">Redis</a></li><li><a href="/blog/note/redis/redis为什么快.html" class="sidebar-link">Redis 为什么快</a></li><li><a href="/blog/note/redis/redis基础数据类型.html" class="sidebar-link">Redis 基础数据类型</a></li><li><a href="/blog/note/redis/redis扩展数据类型.html" class="sidebar-link">Redis 扩展数据类型</a></li><li><a href="/blog/note/redis/redis持久化.html" class="sidebar-link">Redis 持久化</a></li><li><a href="/blog/note/redis/主从模式.html" class="sidebar-link">主从模式</a></li><li><a href="/blog/note/redis/哨兵机制.html" class="sidebar-link">哨兵机制</a></li><li><a href="/blog/note/redis/redis集群.html" class="sidebar-link">Redis 集群</a></li><li><a href="/blog/note/redis/雪崩 穿透 击穿.html" class="sidebar-link">雪崩 穿透 击穿</a></li><li><a href="/blog/note/redis/缓存和数据库的数据一致性.html" class="sidebar-link">如何保持缓存和数据库的数据一致性</a></li><li><a href="/blog/note/redis/redis分布式锁.html" class="sidebar-link">Redis 分布式锁</a></li><li><a href="/blog/note/redis/redis缓冲区.html" class="sidebar-link">Redis 缓冲区</a></li><li><a href="/blog/note/redis/redis内存模型.html" class="active sidebar-link">Redis 内存模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/note/redis/redis内存模型.html#redis-内存模型-2" class="sidebar-link">Redis 内存模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/note/redis/redis内存模型.html#内存统计" class="sidebar-link">内存统计</a></li><li class="sidebar-sub-header"><a href="/blog/note/redis/redis内存模型.html#内存划分" class="sidebar-link">内存划分</a></li><li class="sidebar-sub-header"><a href="/blog/note/redis/redis内存模型.html#redis-数据存储细节" class="sidebar-link">Redis 数据存储细节</a></li><li class="sidebar-sub-header"><a href="/blog/note/redis/redis内存模型.html#参考" class="sidebar-link">参考</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>zookeeper</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="redis-内存模型"><a href="#redis-内存模型" class="header-anchor">#</a> Redis 内存模型</h1> <h2 id="redis-内存模型-2"><a href="#redis-内存模型-2" class="header-anchor">#</a> Redis 内存模型</h2> <h3 id="内存统计"><a href="#内存统计" class="header-anchor">#</a> 内存统计</h3> <p>查看内存使用情况</p> <p>info memory</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>127.0.0.1:6379&gt; info memory
# Memory
used_memory:700400
used_memory_human:683.98K
used_memory_rss:663456
used_memory_peak:700400
used_memory_peak_human:683.98K
used_memory_lua:36864
mem_fragmentation_ratio:0.95
mem_allocator:jemalloc-3.6.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>参数说明</strong></p> <ul><li><p>**used_memory：**Redis分配器分配的内存总量（单位是字节），包括使用的虚拟内存（即swap）</p></li> <li><p>**used_memory_rss：**Redis进程占据操作系统的内存（单位是字节），与top及ps命令看到的值是一致的</p></li> <li><p>**mem_fragmentation_ratio：**内存碎片比率，该值是used_memory_rss / used_memory的比值。</p></li> <li><p>**mem_allocator：**Redis使用的内存分配器，在编译时指定；</p></li></ul> <h3 id="内存划分"><a href="#内存划分" class="header-anchor">#</a> 内存划分</h3> <p>Redis 内存占用只要分为以下部分</p> <h4 id="数据"><a href="#数据" class="header-anchor">#</a> 数据</h4> <h4 id="进程本身运行需要的内存"><a href="#进程本身运行需要的内存" class="header-anchor">#</a> 进程本身运行需要的内存</h4> <h4 id="缓冲内存"><a href="#缓冲内存" class="header-anchor">#</a> 缓冲内存</h4> <h4 id="内存碎片"><a href="#内存碎片" class="header-anchor">#</a> 内存碎片</h4> <h3 id="redis-数据存储细节"><a href="#redis-数据存储细节" class="header-anchor">#</a> Redis 数据存储细节</h3> <p>内存分配器（如jemalloc）、简单动态字符串（SDS）、5种对象类型及内部编码、redisObject。</p> <p>执行set hello world涉及到的数据模型：</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/2441834/1614389654389-18cb04d9-d057-4fcd-aac3-0501caf6d392.png" alt="img"></p> <h4 id="jemalloc-内存分配器"><a href="#jemalloc-内存分配器" class="header-anchor">#</a> jemalloc（内存分配器）</h4> <p>Redis 在编译时便会指定内存分配器；内存分配器可以是 libc 、jemalloc 或者 tcmalloc，默认是 jemalloc。</p> <p>特点</p> <ul><li><p>jemalloc作为Redis的默认内存分配器，在减小内存碎片方面做的相对比较好。</p></li> <li><p>jemalloc在64位系统中，将内存空间划分为小、大、巨大三个范围；</p></li> <li><p>每个范围内又划分了许多小的内存块单位；</p></li> <li><p>当Redis存储数据时，会选择大小最合适的内存块进行存储。</p></li></ul> <p>例如，如果需要存储大小为130字节的对象，jemalloc会将其放入160字节的内存单元中。</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/2441834/1614389727623-32a779c4-5326-4c87-9d76-c0e7e1f396c4.png" alt="img"></p> <h4 id="redisobject"><a href="#redisobject" class="header-anchor">#</a> redisObject</h4> <p>Redis 中的对象存储在redisObject 中。</p> <p>redisObject 的结构与对象类型、编码、内存回收、共享对象都有关系；一个redisObject 对象的大小为16字节：</p> <p>4bit+4bit+24bit+4Byte+8Byte=16Byte。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>typedef struct redisObject {
　　unsigned type:4;
　　unsigned encoding:4;
　　unsigned lru:REDIS_LRU_BITS; /* lru time (relative to server.lruclock) */
　　int refcount;
　　void *ptr;
} robj;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>type</li></ul> <p>type字段表示对象的类型，占4个比特；包含五个基础数据类型</p> <ul><li>encoding</li></ul> <p>encoding表示对象的内部编码，占4个比特</p> <p>关于Redis内部编码的转换，都符合以下规律：<strong>编码转换在Redis写入数据时完成，且转换过程不可逆，只能从小内存编码向大内存编码转换</strong>。</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/2441834/1614389843487-57aa7709-f004-4cc9-ae02-1cacc9c3ee0e.png" alt="img"></p> <ul><li>lru</li></ul> <p>lru记录的是对象最后一次被命令程序访问的时间，占据的比特数不同的版本有所不同（如4.0版本占24比特，2.6版本占22比特）。</p> <ul><li>refcount</li></ul> <p>refcount记录的是该对象被引用的次数，类型为整型。</p> <p>refcount的作用，主要在于对象的引用计数和内存回收。当创建新对象时，refcount初始化为1；当有新程序使用该对象时，refcount加1；当对象不再被一个新程序使用时，refcount减1；当refcount变为0时，对象占用的内存会被释放。</p> <ul><li>ptr</li></ul> <p>ptr指针指向具体的数据，如前面的例子中，set hello world，ptr指向包含字符串world的SDS。</p> <h4 id="sds-simple-dynamic-string"><a href="#sds-simple-dynamic-string" class="header-anchor">#</a> SDS(Simple Dynamic String)</h4> <p>Redis 没有直接使用C 字符串(即以空字符’\0’结尾的字符数组)作为默认的字符串表示，而是使用了SDS。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>struct sdshdr {
    int len;
    int free;
    char buf[];
};
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>buf表示字节数组，用来存储字符串；len表示buf已使用的长度，free表示buf未使用的长度。</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/2441834/1614389991218-0789fb43-2a86-4490-a09d-5a3e24100733.png" alt="img"></p> <h4 id="估算-redis-内存使用量"><a href="#估算-redis-内存使用量" class="header-anchor">#</a> <a href="http://www.redis.cn/redis_memory/" target="_blank" rel="noopener noreferrer"><strong>估算 Redis 内存使用量</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <h3 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h3> <p>https://www.cnblogs.com/kismetv/p/8654978.html</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/note/redis/redis缓冲区.html" class="prev">
        Redis 缓冲区
      </a></span> <span class="next"><a href="/blog/note/zk/zookeeper.html">
        Zookeeper
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.9d120f23.js" defer></script><script src="/blog/assets/js/2.0274c0be.js" defer></script><script src="/blog/assets/js/24.806fb0cd.js" defer></script>
  </body>
</html>
