<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis 分布式锁 | zchzh的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="怎么还有😇">
    
    <link rel="preload" href="/blog/assets/css/0.styles.dcea0daa.css" as="style"><link rel="preload" href="/blog/assets/js/app.1032a92f.js" as="script"><link rel="preload" href="/blog/assets/js/2.e1e07fc1.js" as="script"><link rel="preload" href="/blog/assets/js/22.c1eec567.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.e1a10c99.js"><link rel="prefetch" href="/blog/assets/js/11.5b0d1e07.js"><link rel="prefetch" href="/blog/assets/js/12.af40081d.js"><link rel="prefetch" href="/blog/assets/js/13.2b16bf0d.js"><link rel="prefetch" href="/blog/assets/js/14.c8912ed1.js"><link rel="prefetch" href="/blog/assets/js/15.ca2ecf28.js"><link rel="prefetch" href="/blog/assets/js/16.7d9aaac1.js"><link rel="prefetch" href="/blog/assets/js/17.bbf84593.js"><link rel="prefetch" href="/blog/assets/js/18.933efef2.js"><link rel="prefetch" href="/blog/assets/js/19.18e8e50e.js"><link rel="prefetch" href="/blog/assets/js/20.5dd283cf.js"><link rel="prefetch" href="/blog/assets/js/21.196a350c.js"><link rel="prefetch" href="/blog/assets/js/23.8fdb871b.js"><link rel="prefetch" href="/blog/assets/js/24.6a138dc9.js"><link rel="prefetch" href="/blog/assets/js/25.223b56e4.js"><link rel="prefetch" href="/blog/assets/js/26.47fb6eaa.js"><link rel="prefetch" href="/blog/assets/js/27.cde76030.js"><link rel="prefetch" href="/blog/assets/js/28.87da798e.js"><link rel="prefetch" href="/blog/assets/js/29.7b2269ea.js"><link rel="prefetch" href="/blog/assets/js/3.f1d32b61.js"><link rel="prefetch" href="/blog/assets/js/30.39e11517.js"><link rel="prefetch" href="/blog/assets/js/31.99d13f98.js"><link rel="prefetch" href="/blog/assets/js/32.86ce4f71.js"><link rel="prefetch" href="/blog/assets/js/33.1254f04d.js"><link rel="prefetch" href="/blog/assets/js/34.40d848f5.js"><link rel="prefetch" href="/blog/assets/js/35.217f3301.js"><link rel="prefetch" href="/blog/assets/js/36.0645238f.js"><link rel="prefetch" href="/blog/assets/js/37.2fdd75ef.js"><link rel="prefetch" href="/blog/assets/js/38.c6a1efe1.js"><link rel="prefetch" href="/blog/assets/js/39.f249f7de.js"><link rel="prefetch" href="/blog/assets/js/4.3e4b663b.js"><link rel="prefetch" href="/blog/assets/js/5.208bc09a.js"><link rel="prefetch" href="/blog/assets/js/6.8b2b6085.js"><link rel="prefetch" href="/blog/assets/js/7.b2b3e8b0.js"><link rel="prefetch" href="/blog/assets/js/8.d8b62c56.js"><link rel="prefetch" href="/blog/assets/js/9.904b3307.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.dcea0daa.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">zchzh的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/note/" class="nav-link router-link-active">
  笔记
</a></div><div class="nav-item"><a href="/blog/interview/" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="/blog/other/" class="nav-link">
  其他
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/puck-ini" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://puck-ini.github.io/blog/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/note/" class="nav-link router-link-active">
  笔记
</a></div><div class="nav-item"><a href="/blog/interview/" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="/blog/other/" class="nav-link">
  其他
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/puck-ini" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://puck-ini.github.io/blog/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>java笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>redis笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/note/redis/redis.html" class="sidebar-link">Redis</a></li><li><a href="/blog/note/redis/redis为什么快.html" class="sidebar-link">Redis 为什么快</a></li><li><a href="/blog/note/redis/redis基础数据类型.html" class="sidebar-link">Redis 基础数据类型</a></li><li><a href="/blog/note/redis/redis扩展数据类型.html" class="sidebar-link">Redis 扩展数据类型</a></li><li><a href="/blog/note/redis/redis持久化.html" class="sidebar-link">Redis 持久化</a></li><li><a href="/blog/note/redis/主从模式.html" class="sidebar-link">主从模式</a></li><li><a href="/blog/note/redis/哨兵机制.html" class="sidebar-link">哨兵机制</a></li><li><a href="/blog/note/redis/redis集群.html" class="sidebar-link">Redis 集群</a></li><li><a href="/blog/note/redis/雪崩 穿透 击穿.html" class="sidebar-link">雪崩 穿透 击穿</a></li><li><a href="/blog/note/redis/缓存和数据库的数据一致性.html" class="sidebar-link">如何保持缓存和数据库的数据一致性</a></li><li><a href="/blog/note/redis/redis分布式锁.html" class="active sidebar-link">Redis 分布式锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/note/redis/redis分布式锁.html#什么是分布式锁" class="sidebar-link">什么是分布式锁</a></li><li class="sidebar-sub-header"><a href="/blog/note/redis/redis分布式锁.html#分布式锁实现" class="sidebar-link">分布式锁实现</a></li><li class="sidebar-sub-header"><a href="/blog/note/redis/redis分布式锁.html#redis-分布式锁实现" class="sidebar-link">Redis 分布式锁实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/note/redis/redis分布式锁.html#set" class="sidebar-link">set</a></li><li class="sidebar-sub-header"><a href="/blog/note/redis/redis分布式锁.html#setnx" class="sidebar-link">setnx</a></li><li class="sidebar-sub-header"><a href="/blog/note/redis/redis分布式锁.html#set-nx-px" class="sidebar-link">set nx px</a></li><li class="sidebar-sub-header"><a href="/blog/note/redis/redis分布式锁.html#唯一值" class="sidebar-link">唯一值</a></li><li class="sidebar-sub-header"><a href="/blog/note/redis/redis分布式锁.html#lua-脚本" class="sidebar-link">Lua 脚本</a></li><li class="sidebar-sub-header"><a href="/blog/note/redis/redis分布式锁.html#重入锁" class="sidebar-link">重入锁</a></li><li class="sidebar-sub-header"><a href="/blog/note/redis/redis分布式锁.html#阻塞等待" class="sidebar-link">阻塞等待</a></li><li class="sidebar-sub-header"><a href="/blog/note/redis/redis分布式锁.html#定时任务" class="sidebar-link">定时任务</a></li><li class="sidebar-sub-header"><a href="/blog/note/redis/redis分布式锁.html#redisson" class="sidebar-link">Redisson</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/note/redis/redis分布式锁.html#redlock-多节点分布式锁" class="sidebar-link">RedLock（多节点分布式锁）</a></li><li class="sidebar-sub-header"><a href="/blog/note/redis/redis分布式锁.html#参考" class="sidebar-link">参考</a></li></ul></li><li><a href="/blog/note/redis/redis缓冲区.html" class="sidebar-link">Redis 缓冲区</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>springboot</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="redis-分布式锁"><a href="#redis-分布式锁" class="header-anchor">#</a> Redis 分布式锁</h1> <h2 id="什么是分布式锁"><a href="#什么是分布式锁" class="header-anchor">#</a> 什么是分布式锁</h2> <p>单机情况下，当多线程操作共享变量时，为了保证数据的一致性，同一时间只能有一个线程在操作该变量，这时候就得上锁。</p> <p>当在集群这种多机的情况时，单机上的锁无法被其他机器上的线程获取，也就是说不能保证在同一时间只能有一个线程操作该变量，这个时候就得引入一个中间层，保证多机情况下每一个线程都能访问到锁，这就是分布式锁。</p> <h2 id="分布式锁实现"><a href="#分布式锁实现" class="header-anchor">#</a> 分布式锁实现</h2> <p>分布式锁的实现可以有很多种，例如关系型数据库，Zookeeper，分布式缓存等。</p> <p>本文主要介绍分布式缓存 Redis 的分布式锁实现。</p> <h2 id="redis-分布式锁实现"><a href="#redis-分布式锁实现" class="header-anchor">#</a> Redis 分布式锁实现</h2> <p>锁要保证互斥性，分布式锁也不例外，Redis 中可以使用键值对保存锁，在同一时间确保只能让一个客户端获取到锁。</p> <h3 id="set"><a href="#set" class="header-anchor">#</a> set</h3> <p>保证互斥性可以直接使用 set 命令，因为 Redis 是单线程处理命令，所以不会造成多个客户端同时获取到锁。首先约定好 key 值，这样所有客户端都能访问到锁，value 值为0表示未获取到锁，1表示获取到锁。当有客户端试图获取锁时先判断值是否为0，为0则将 value 设置为1表示已有客户端获取到锁，其他客户端在获取锁时就无法获取成功。</p> <p><strong>存在的问题：</strong></p> <p>虽然 Redis 单线程处理命令可以保证只有一个客户端获取到锁，但是客户端方面却无法保证，因为客户端获取锁需要先判断值是否为0 ，之后才会设置锁的值为1，这两个操作无法保证获取锁的原子性。</p> <h3 id="setnx"><a href="#setnx" class="header-anchor">#</a> setnx</h3> <p>setnx 的意思是 set if not exist。这个操作在 Redis 2.6.12 版本及之后支持，该命令会在设置键值对时判断库中是否存在，如果不存在就会创建键值对，设置成功会返回1，失败会返回0，这样判断和加锁的操作就可以直接使用 setnx 命令。</p> <p><strong>存在问题：</strong></p> <p>如果获取到锁的客户端崩溃了就会导致锁一直不能被释放，其他客户端也无法加锁。</p> <h3 id="set-nx-px"><a href="#set-nx-px" class="header-anchor">#</a> set nx px</h3> <p>根据上述问题可以使用 set nx px 命令（2.6.12），该命令在保证 setnx 的功能同时可以对 key 设置过时间。这样获取到锁的客户端崩溃了也不会一直持有锁导致其他客户端无法获取锁。</p> <p><strong>存在问题：</strong></p> <p>设置了过期时间之后锁可能会被误删，例如客户端 A 获取到锁之后处理业务时间超时导致锁过期了，这个时候客户端 B 获取到锁还没进行业务处理时，客户端 A 刚好处理完将锁删了就会导致客户端 B 获取到的锁被误删。</p> <h3 id="唯一值"><a href="#唯一值" class="header-anchor">#</a> 唯一值</h3> <p>为了防止锁被误删，可以将锁的 value 设置成客户端的唯一标识，这样在删除锁是先判断唯一值是否是自己上的锁，即谁上的锁谁才能删除。</p> <p><strong>存在问题：</strong></p> <p>原本的删除锁只是一个操作，是原子性的，但是这次多了判断之后就会导致删除锁也变成不是原子性的。</p> <h3 id="lua-脚本"><a href="#lua-脚本" class="header-anchor">#</a> Lua 脚本</h3> <p>Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p> <p>Redis 在执行 lua 脚本时是原子性的，不会被其他请求打断。</p> <p>获取锁：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&quot;if redis.call('setnx',KEYS[1],ARGV[1])==1 then\n&quot; +
&quot;    if redis.call('get',KEYS[1])==ARGV[1] then\n&quot; +
&quot;        return redis.call('expire',KEYS[1],ARGV[2])\n&quot; +
&quot;    else\n&quot; +
&quot;        return 0\n&quot; +
&quot;    end\n&quot; +
&quot;else\n&quot; +
&quot;end&quot;;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>删除锁：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 释放锁 比较value是否相等，避免误释放
&quot;if redis.call(\&quot;get\&quot;,KEYS[1]) == ARGV[1] then\n&quot; +
&quot;    return redis.call(\&quot;del\&quot;,KEYS[1])\n&quot; +
&quot;else\n&quot; +
&quot;    return 0\n&quot; +
&quot;end&quot;;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>存在问题：</strong></p> <p>锁不可重入，不支持阻塞等待，业务处理时间大于锁过期时间无法续期。</p> <h3 id="重入锁"><a href="#重入锁" class="header-anchor">#</a> 重入锁</h3> <p>可重入锁的最大作用是防止死锁。重入多少次就得释放多少次</p> <p>不可重入锁例子。test1() 重复加锁会导致死锁。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpinLock</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> owner <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 将当前线程设置成锁
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>owner<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 释放锁
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> unlock <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        owner<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * SpinLock 是不可重入锁， 该方法会重复加锁会产生死锁
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// test2 方法也使用了 SpinLock 加锁</span>
            <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;test2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpinLock</span> spinLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpinLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        spinLock<span class="token punctuation">.</span><span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>解决不可重入锁可以增加一个计数，在重复加锁时计数加1，释放锁时计数键1</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpinLock1</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> owner <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">==</span>owner<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>owner<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> unlock <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>current<span class="token operator">==</span>owner<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                count<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                owner<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;test2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpinLock1</span> spinLock1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpinLock1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        spinLock1<span class="token punctuation">.</span><span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h3 id="阻塞等待"><a href="#阻塞等待" class="header-anchor">#</a> 阻塞等待</h3> <p>在获取不到锁的时候可以在一个循环中使用 Object.wait() 、Condition.await()、LockSupport.park() 等方法。</p> <h3 id="定时任务"><a href="#定时任务" class="header-anchor">#</a> 定时任务</h3> <p>解决业务处理时间大于锁过期时间的问题可以设置比较大的锁过期时间，但是这样无法做到将问题根本解决。这个时候可以使用一个定时任务在锁快过期时为锁重新设置过期时间。</p> <h3 id="redisson"><a href="#redisson" class="header-anchor">#</a> Redisson</h3> <blockquote><p>Redisson是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务。其中包括(BitSet, Set, Multimap, SortedSet, Map, List, Queue, BlockingQueue, Deque, BlockingDeque, Semaphore, Lock, AtomicLong, CountDownLatch, Publish / Subscribe, Bloom filter, Remote service, Spring cache, Executor service, Live Object service, Scheduler service) Redisson提供了使用Redis的最简单和最便捷的方法。Redisson的宗旨是促进使用者对Redis的关注分离（Separation of Concern），从而让使用者能够将精力更集中地放在处理业务逻辑上。</p></blockquote> <p>简而言之 Redisson 是一个 Java 实现的操作 Redis 的客户端。使用 Redisson 提供的分布式锁功能可以避免上述所说的所有问题。</p> <h4 id="唯一值-2"><a href="#唯一值-2" class="header-anchor">#</a> 唯一值</h4> <p>使用的是UUID + 当前线程Id</p> <p>![image-20210121150056729](../../.vuepress/public/img/redis fbss/image-20210121150056729.png)</p> <h4 id="加锁-lua-脚本。"><a href="#加锁-lua-脚本。" class="header-anchor">#</a> 加锁 lua 脚本。</h4> <p>Redisson 实现的分布式锁使用的是 Redis hash 数据类型，key 保存锁名，field 保存客户端的唯一值，value 表示重入次数。</p> <blockquote><p>如果锁不存在设置锁，同时设置锁的过期时间（internalLockLeaseTime），return</p> <p>如果锁存在，判断是否属于自己加的锁，如果是则将值加1，同时将重新设置过期时间（重入锁）。</p> <p>如果锁存在并且不属于自己加的锁则返回锁目前剩余的过期时间。</p></blockquote> <p>![image-20210121150034511](../../.vuepress/public/img/redis fbss/image-20210121150034511.png)</p> <h4 id="解锁-lua-脚本。"><a href="#解锁-lua-脚本。" class="header-anchor">#</a> 解锁 lua 脚本。</h4> <blockquote><p>如果锁不存在，publish 发送锁已经解锁的消息。</p> <p>如果锁存在，判断是否属于自己创建的锁，不属于自己的锁直接返回不处理。</p> <p>如果属于自己的锁，将值减1并返回，判断该值如果大于0，重新设置锁的过期时间，否则删除该锁并发布锁已经解锁的消息。</p></blockquote> <p>![image-20210121145836082](../../.vuepress/public/img/redis fbss/image-20210121145836082.png)</p> <p>可以看到解锁脚本中有一个发布事件的处理，这个发布事件的作用主要是通知其他正在阻塞获取锁的客户端锁已经被释放，可以再次获取锁。</p> <h4 id="阻塞等待-2"><a href="#阻塞等待-2" class="header-anchor">#</a> 阻塞等待</h4> <p>Redisson 的阻塞等待使用了 Redis 的 pub/sub 机制（发布订阅机制）。当客户端未获取到锁时会订阅一个频道等待获取锁的客户端释放锁时发布释放锁事件。</p> <p>![image-20210412135634196](../../.vuepress/public/img/redis fbss/image-20210412135634196.png)</p> <h4 id="锁续期。"><a href="#锁续期。" class="header-anchor">#</a> 锁续期。</h4> <p>续期只有在获取锁时不设置等待时间和过期时间才会自动续期，当客户端获取到锁时会开启一个定时任务续期。Redisson 锁默认情况下锁的过期时间为30秒，每10秒给锁续期的时间也为30秒。</p> <p>![image-20210407153223447](../../.vuepress/public/img/redis fbss/image-20210407153223447.png)</p> <h2 id="redlock-多节点分布式锁"><a href="#redlock-多节点分布式锁" class="header-anchor">#</a> RedLock（多节点分布式锁）</h2> <p>上述的分布式锁都是在单机情况下的锁，多节点分布式锁是为了保证锁的高可用而存在的。</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <p><a href="https://github.com/redisson/redisson/wiki/1.-%E6%A6%82%E8%BF%B0" target="_blank" rel="noopener noreferrer">Redisson Wiki<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/note/redis/缓存和数据库的数据一致性.html" class="prev">
        如何保持缓存和数据库的数据一致性
      </a></span> <span class="next"><a href="/blog/note/redis/redis缓冲区.html">
        Redis 缓冲区
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.1032a92f.js" defer></script><script src="/blog/assets/js/2.e1e07fc1.js" defer></script><script src="/blog/assets/js/22.c1eec567.js" defer></script>
  </body>
</html>
