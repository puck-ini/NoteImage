<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis 分布式锁 | zchzh的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="怎么还有😇">
    
    <link rel="preload" href="/blog/assets/css/0.styles.093df223.css" as="style"><link rel="preload" href="/blog/assets/js/app.28edea48.js" as="script"><link rel="preload" href="/blog/assets/js/2.0274c0be.js" as="script"><link rel="preload" href="/blog/assets/js/3.fc5c5dde.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.39f93c74.js"><link rel="prefetch" href="/blog/assets/js/11.5e5b0273.js"><link rel="prefetch" href="/blog/assets/js/12.48b1baa1.js"><link rel="prefetch" href="/blog/assets/js/13.af2120c9.js"><link rel="prefetch" href="/blog/assets/js/14.c4045223.js"><link rel="prefetch" href="/blog/assets/js/15.6f6babcd.js"><link rel="prefetch" href="/blog/assets/js/16.6165b9f2.js"><link rel="prefetch" href="/blog/assets/js/17.172ee54c.js"><link rel="prefetch" href="/blog/assets/js/18.f060a0c0.js"><link rel="prefetch" href="/blog/assets/js/19.d646ed3d.js"><link rel="prefetch" href="/blog/assets/js/20.b7061d47.js"><link rel="prefetch" href="/blog/assets/js/21.0db52d00.js"><link rel="prefetch" href="/blog/assets/js/22.879b8fbd.js"><link rel="prefetch" href="/blog/assets/js/23.38093c24.js"><link rel="prefetch" href="/blog/assets/js/24.9600277f.js"><link rel="prefetch" href="/blog/assets/js/25.b4281fa3.js"><link rel="prefetch" href="/blog/assets/js/26.7a471117.js"><link rel="prefetch" href="/blog/assets/js/27.abb64dbe.js"><link rel="prefetch" href="/blog/assets/js/28.09c63d2a.js"><link rel="prefetch" href="/blog/assets/js/29.8e6e62cc.js"><link rel="prefetch" href="/blog/assets/js/30.399ebaac.js"><link rel="prefetch" href="/blog/assets/js/31.2d90cc3c.js"><link rel="prefetch" href="/blog/assets/js/32.89e76fd6.js"><link rel="prefetch" href="/blog/assets/js/33.a8f6024d.js"><link rel="prefetch" href="/blog/assets/js/34.c3ce5b32.js"><link rel="prefetch" href="/blog/assets/js/35.7d5069b9.js"><link rel="prefetch" href="/blog/assets/js/36.6e74292c.js"><link rel="prefetch" href="/blog/assets/js/37.77c5a52d.js"><link rel="prefetch" href="/blog/assets/js/38.73dd2445.js"><link rel="prefetch" href="/blog/assets/js/39.92b52c5b.js"><link rel="prefetch" href="/blog/assets/js/4.d4b9bbeb.js"><link rel="prefetch" href="/blog/assets/js/40.6fd9b8c1.js"><link rel="prefetch" href="/blog/assets/js/41.f47119fe.js"><link rel="prefetch" href="/blog/assets/js/42.72b3c2e9.js"><link rel="prefetch" href="/blog/assets/js/43.e2092105.js"><link rel="prefetch" href="/blog/assets/js/44.b2974379.js"><link rel="prefetch" href="/blog/assets/js/45.7c8632cd.js"><link rel="prefetch" href="/blog/assets/js/46.3964f7fd.js"><link rel="prefetch" href="/blog/assets/js/47.248b4596.js"><link rel="prefetch" href="/blog/assets/js/48.999c4411.js"><link rel="prefetch" href="/blog/assets/js/49.6082052a.js"><link rel="prefetch" href="/blog/assets/js/5.cff55483.js"><link rel="prefetch" href="/blog/assets/js/50.6111a4b3.js"><link rel="prefetch" href="/blog/assets/js/51.d0f13aa7.js"><link rel="prefetch" href="/blog/assets/js/52.41208edf.js"><link rel="prefetch" href="/blog/assets/js/53.f39ac999.js"><link rel="prefetch" href="/blog/assets/js/54.cc11c37a.js"><link rel="prefetch" href="/blog/assets/js/6.0f60e96d.js"><link rel="prefetch" href="/blog/assets/js/7.ec969d7a.js"><link rel="prefetch" href="/blog/assets/js/8.d3387bae.js"><link rel="prefetch" href="/blog/assets/js/9.1f228b89.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.093df223.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">zchzh的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/note/" class="nav-link router-link-active">
  笔记
</a></div><div class="nav-item"><a href="/blog/interview/" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="/blog/share/" class="nav-link">
  分享
</a></div><div class="nav-item"><a href="/blog/other/" class="nav-link">
  其他
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/puck-ini" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://puck-ini.github.io/blog/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/note/" class="nav-link router-link-active">
  笔记
</a></div><div class="nav-item"><a href="/blog/interview/" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="/blog/share/" class="nav-link">
  分享
</a></div><div class="nav-item"><a href="/blog/other/" class="nav-link">
  其他
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/puck-ini" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://puck-ini.github.io/blog/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>java笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/note/java/java.html" class="sidebar-link">java</a></li><li><a href="/blog/note/java/java Future.html" class="sidebar-link">Future 接口</a></li><li><a href="/blog/note/java/锁类型.html" class="sidebar-link">锁类型</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>springboot</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>zookeeper</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="redis-分布式锁"><a href="#redis-分布式锁" class="header-anchor">#</a> Redis 分布式锁</h1> <h2 id="什么是分布式锁"><a href="#什么是分布式锁" class="header-anchor">#</a> 什么是分布式锁</h2> <p>单机情况下，当多线程操作共享变量时，为了保证数据的一致性，同一时间只能有一个线程在操作该变量，这时候就得上锁。</p> <p>当在集群这种多机的情况时，单机上的锁无法被其他机器上的线程获取，也就是说不能保证在同一时间只能有一个线程操作该变量，这个时候就得引入一个中间层，保证多机情况下每一个线程都能访问到锁，这就是分布式锁。</p> <h2 id="分布式锁实现"><a href="#分布式锁实现" class="header-anchor">#</a> 分布式锁实现</h2> <p>分布式锁的实现可以有很多种，例如关系型数据库，Zookeeper，分布式缓存等。</p> <p>下面主要介绍分布式缓存 Redis 的分布式锁实现。</p> <h2 id="redis-分布式锁实现"><a href="#redis-分布式锁实现" class="header-anchor">#</a> Redis 分布式锁实现</h2> <p>锁要保证互斥性，分布式锁也不例外，Redis 中可以使用键值对保存锁，通过 key 的唯一性在同一时间确保只能让一个客户端获取到锁。</p> <h3 id="set"><a href="#set" class="header-anchor">#</a> set</h3> <p>保证互斥性可以直接使用 set 命令，因为 Redis 是单线程处理命令，所以不会造成多个客户端同时获取到锁。首先约定好 key 值，这样所有客户端都能访问到锁，value 值为0表示未获取到锁，1表示获取到锁。当有客户端试图获取锁时先判断值是否为0，为0则将 value 设置为1表示已有客户端获取到锁，其他客户端在获取锁时就无法获取成功。</p> <p><strong>存在的问题：</strong></p> <p>虽然 Redis 单线程处理命令可以保证只有一个客户端获取到锁，但是客户端方面因为要经过判断和设置值，这两个操作无法保证原子性，所以会导致多个客户端获取到锁。</p> <h3 id="setnx"><a href="#setnx" class="header-anchor">#</a> setnx</h3> <p>setnx 的意思是 set if not exist。这个操作在 Redis 2.6.12 版本及之后支持，该命令会在设置键值对时判断库中是否存在，如果不存在就会创建键值对，设置成功会返回1，失败会返回0，这样判断和加锁的操作就可以直接使用 setnx 命令。</p> <p><strong>存在问题：</strong></p> <p>如果获取到锁的客户端崩溃了就会导致锁一直不能被释放，其他客户端也无法加锁。</p> <h3 id="set-nx-px"><a href="#set-nx-px" class="header-anchor">#</a> set nx px</h3> <p>根据上述问题可以使用 set nx px 命令（2.6.12），该命令在保证 setnx 的功能同时可以对 key 设置过时间。这样获取到锁的客户端崩溃了也不会一直持有锁导致其他客户端无法获取锁。</p> <p><strong>存在问题：</strong></p> <p>设置了过期时间之后锁可能会被误删，例如客户端 A 获取到锁之后处理业务时间超时导致锁过期了，这个时候客户端 B 获取到锁还没进行业务处理时，客户端 A 刚好处理完将锁删了就会导致客户端 B 获取到的锁被误删。</p> <h3 id="唯一值"><a href="#唯一值" class="header-anchor">#</a> 唯一值</h3> <p>为了防止锁被误删，可以将锁的 value 设置成客户端的唯一标识，这样在删除锁是先判断唯一值是否是自己上的锁，即谁上的锁谁才能删除。</p> <p><strong>存在问题：</strong></p> <p>原本的删除锁只是一个操作，是原子性的，但是这次多了判断之后就会导致删除锁也变成不是原子性的。</p> <h3 id="lua-脚本"><a href="#lua-脚本" class="header-anchor">#</a> Lua 脚本</h3> <p>Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p> <p>Redis 在执行 lua 脚本时是原子性的，不会被其他请求打断。</p> <p>获取锁：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&quot;if redis.call('setnx',KEYS[1],ARGV[1])==1 then\n&quot; +
&quot;    if redis.call('get',KEYS[1])==ARGV[1] then\n&quot; +
&quot;        return redis.call('expire',KEYS[1],ARGV[2])\n&quot; +
&quot;    else\n&quot; +
&quot;        return 0\n&quot; +
&quot;    end\n&quot; +
&quot;else\n&quot; +
&quot;end&quot;;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>删除锁：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 释放锁 比较value是否相等，避免误释放
&quot;if redis.call(\&quot;get\&quot;,KEYS[1]) == ARGV[1] then\n&quot; +
&quot;    return redis.call(\&quot;del\&quot;,KEYS[1])\n&quot; +
&quot;else\n&quot; +
&quot;    return 0\n&quot; +
&quot;end&quot;;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>存在问题：</strong></p> <p>锁不可重入，不支持阻塞等待，业务处理时间大于锁过期时间无法续期。</p> <h3 id="重入锁"><a href="#重入锁" class="header-anchor">#</a> 重入锁</h3> <p>可重入锁的最大作用是防止死锁。重入多少次就得释放多少次</p> <p>不可重入锁例子。test1() 重复加锁会导致死锁。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpinLock</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> owner <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 将当前线程设置成锁
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>owner<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 释放锁
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> unlock <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        owner<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * SpinLock 是不可重入锁， 该方法会重复加锁会产生死锁
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// test2 方法也使用了 SpinLock 加锁</span>
            <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;test2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpinLock</span> spinLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpinLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        spinLock<span class="token punctuation">.</span><span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>解决不可重入锁可以增加一个计数，在重复加锁时计数加1，释放锁时计数键1</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpinLock1</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> owner <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">==</span>owner<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>owner<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> unlock <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>current<span class="token operator">==</span>owner<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                count<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                owner<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;test2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpinLock1</span> spinLock1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpinLock1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        spinLock1<span class="token punctuation">.</span><span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h3 id="阻塞等待"><a href="#阻塞等待" class="header-anchor">#</a> 阻塞等待</h3> <p>可以在一个循环中不停的获取锁，但是这样效率会很低。</p> <h3 id="定时任务"><a href="#定时任务" class="header-anchor">#</a> 定时任务</h3> <p>解决业务处理时间大于锁过期时间的问题可以设置比较大的锁过期时间，但是这样无法做到将问题根本解决。这个时候可以使用一个定时任务在锁快过期时为锁重新设置过期时间。</p> <h3 id="redisson"><a href="#redisson" class="header-anchor">#</a> Redisson</h3> <blockquote><p>Redisson是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务。其中包括(BitSet, Set, Multimap, SortedSet, Map, List, Queue, BlockingQueue, Deque, BlockingDeque, Semaphore, Lock, AtomicLong, CountDownLatch, Publish / Subscribe, Bloom filter, Remote service, Spring cache, Executor service, Live Object service, Scheduler service) Redisson提供了使用Redis的最简单和最便捷的方法。Redisson的宗旨是促进使用者对Redis的关注分离（Separation of Concern），从而让使用者能够将精力更集中地放在处理业务逻辑上。</p></blockquote> <p>简而言之 Redisson 是一个 Java 实现的操作 Redis 的客户端。使用 Redisson 提供的分布式锁功能可以避免上述所说的所有问题。</p> <h4 id="唯一值-2"><a href="#唯一值-2" class="header-anchor">#</a> 唯一值</h4> <p>使用的是UUID + 当前线程Id</p> <p><img src="data:image/png;base64,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" alt="image-20210121150056729"></p> <h4 id="加锁-lua-脚本。"><a href="#加锁-lua-脚本。" class="header-anchor">#</a> 加锁 lua 脚本。</h4> <p>Redisson 实现的分布式锁使用的是 Redis hash 数据类型，key 保存锁名，field 保存客户端的唯一值，value 表示重入次数。</p> <blockquote><p>如果锁不存在设置锁，同时设置锁的过期时间（internalLockLeaseTime），return</p> <p>如果锁存在，判断是否属于自己加的锁，如果是则将值加1，同时将重新设置过期时间（重入锁）。</p> <p>如果锁存在并且不属于自己加的锁则返回锁目前剩余的过期时间。</p></blockquote> <p><img src="/blog/assets/img/image-20210121150034511.63973e4e.png" alt="image-20210121150034511"></p> <h4 id="解锁-lua-脚本。"><a href="#解锁-lua-脚本。" class="header-anchor">#</a> 解锁 lua 脚本。</h4> <blockquote><p>如果锁不存在，publish 发送锁已经解锁的消息。</p> <p>如果锁存在，判断是否属于自己创建的锁，不属于自己的锁直接返回不处理。</p> <p>如果属于自己的锁，将值减1并返回，判断该值如果大于0，重新设置锁的过期时间，否则删除该锁并发布锁已经解锁的消息。</p></blockquote> <p><img src="/blog/assets/img/image-20210121145836082.0742e95d.png" alt="image-20210121145836082"></p> <p>可以看到解锁脚本中有一个发布事件的处理，这个发布事件的作用主要是通知其他正在阻塞获取锁的客户端锁已经被释放，可以再次获取锁。</p> <h4 id="阻塞等待-2"><a href="#阻塞等待-2" class="header-anchor">#</a> 阻塞等待</h4> <p>Redisson 的阻塞等待使用了 Redis 的 pub/sub 机制（发布订阅机制）。当客户端未获取到锁时会订阅一个频道等待获取锁的客户端释放锁时发布释放锁事件。</p> <p><img src="/blog/assets/img/image-20210412135634196.5eaf3265.png" alt="image-20210412135634196"></p> <h4 id="锁续期。"><a href="#锁续期。" class="header-anchor">#</a> 锁续期。</h4> <p>续期只有在获取锁时不设置等待时间和过期时间才会自动续期，当客户端获取到锁时会开启一个定时任务续期。Redisson 锁默认情况下锁的过期时间为30秒，每10秒给锁续期的时间也为30秒。</p> <p><img src="/blog/assets/img/image-20210407153223447.4c018e57.png" alt="image-20210407153223447"></p> <h2 id="redlock-多节点分布式锁"><a href="#redlock-多节点分布式锁" class="header-anchor">#</a> RedLock（多节点分布式锁）</h2> <p>上述的分布式锁都是在单机情况下的锁，多节点分布式锁是为了保证锁的高可用而存在的。</p> <p>Redlock 是 Redis 作者 antirez 提出的算法，在 Redis 的分布式环境中，我们假设有N个Redis master。这些节点<strong>完全互相独立，不存在主从复制或者其他集群协调机制。当且仅当从大多数（N/2+1）的 Redis 节点都取到锁，并且使用的时间小于锁失效时间时，锁才算获取成功</strong>。</p> <blockquote><p>Redlock 的方案不再需要部署从库和哨兵实例，只部署主库，但主库要部署多个，官方推荐至少 5 个实例。</p></blockquote> <h3 id="redlock-流程"><a href="#redlock-流程" class="header-anchor">#</a> RedLock 流程</h3> <ol><li>客户端先获取「当前时间戳T1」</li> <li>客户端依次向这 5 个 Redis 实例发起加锁请求（用前面讲到的 SET 命令），且每个请求会设置超时时间（毫秒级，要远小于锁的有效时间），如果某一个实例加锁失败（包括网络超时、锁被其它人持有等各种异常情况），就立即向下一个 Redis 实例申请加锁</li> <li>如果客户端从 &gt;=3 个（大多数，N / 2 + 1）以上 Redis 实例加锁成功，则再次获取「当前时间戳T2」，如果 T2 - T1 &lt; 锁的过期时间，此时，认为客户端加锁成功，否则认为加锁失败</li> <li>加锁成功，去操作共享资源（例如修改 MySQL 某一行，或发起一个 API 请求）</li> <li>加锁失败，向「全部节点」发起释放锁请求（前面讲到的 Lua 脚本释放锁）</li></ol> <h3 id="redlock-安全吗"><a href="#redlock-安全吗" class="header-anchor">#</a> RedLock 安全吗？</h3> <p>见参考文章。</p> <p>我们首先来看看分布式系统常见的问题：</p> <ul><li>N：Network Delay，网络延迟</li></ul> <p>TCP 虽然保证了传输的可靠性，但是网络延迟是无法避免的</p> <ul><li>P：Process Pause，进程暂停</li></ul> <p>例如 Java 中的 GC （垃圾回收）</p> <ul><li>C：Clock Drift，时钟跳跃</li></ul> <p>使用 NTP 协议将本地设备时间与专门的时间服务器对其，造成的结果是设备的本地时间突然向前或向后跳跃。</p> <p>知道了常见问题之后再来看看 RedLock 是如何处理的。</p> <h4 id="网络延迟和进程暂停问题"><a href="#网络延迟和进程暂停问题" class="header-anchor">#</a> 网络延迟和进程暂停问题</h4> <p>在发生网络延迟或者进程暂停的时候，如果问题发生在 1 到 3 步之间，可以看到 RedLock 的第三步就能检测出来，这样会判断加锁失败。如果发生在之后，即客户端已经拿到锁了，可能会导致客户端去操作共享资源但是锁已经失效，所以这时候可以说是不可靠的，但是这对于大部分的分布式锁来说都会遇到的问题，不能单纯的用于证明 RedLock 不安全。</p> <h4 id="时钟跳跃问题"><a href="#时钟跳跃问题" class="header-anchor">#</a> 时钟跳跃问题</h4> <p>我们再看看时钟跳跃。假设有 ABCDE 5个 Redis 实例，客户端1在 ABC 上加锁成功，这个时候 C 发生了时钟向前跳跃导致锁提前过期，这个时候客户端 2 在 CDE 上加锁成功，这样就会出现问题。所以 RedLock 是可以看作不安全的。虽然时钟跳跃可以在一定程度上避免，例如不要手动修改时钟、通过恰当的运维保证机器不会出现大幅度的跳跃（每次通过微小的调整来完成）。</p> <p>因此在需要保证可靠服务的场景需要使用分布式锁是尽量不要使用 Redis 做分布式锁，虽然时钟跳跃可以人为的在一定程度上避免，但是这个问题还是不能保证一定能解决，这个时候使用 Zookeeper 作为分布式锁会是更好的选择。（Zookeeper 也是无法解决网络延迟和进程暂停的问题，但是可以解决时钟跳跃的问题）</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <p><a href="https://github.com/redisson/redisson/wiki/1.-%E6%A6%82%E8%BF%B0" target="_blank" rel="noopener noreferrer">Redisson Wiki<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://mp.weixin.qq.com/s/s8xjm1ZCKIoTGT3DCVA4aw" target="_blank" rel="noopener noreferrer">深度剖析：Redis分布式锁到底安全吗？看完这篇文章彻底懂了！ (qq.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html" target="_blank" rel="noopener noreferrer">How to do distributed locking — Martin Kleppmann’s blog<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://antirez.com/news/101" target="_blank" rel="noopener noreferrer">Is Redlock safe? - <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://zhangtielei.com/posts/blog-redlock-reasoning.html" target="_blank" rel="noopener noreferrer">基于Redis的分布式锁到底安全吗（上）？ - 铁蕾的个人博客 (zhangtielei.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://zhangtielei.com/posts/blog-redlock-reasoning-part2.html" target="_blank" rel="noopener noreferrer">基于Redis的分布式锁到底安全吗（下）？ - 铁蕾的个人博客 (zhangtielei.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.28edea48.js" defer></script><script src="/blog/assets/js/2.0274c0be.js" defer></script><script src="/blog/assets/js/3.fc5c5dde.js" defer></script>
  </body>
</html>
