<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>分布式锁 | zchzh的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="怎么还有😇">
    
    <link rel="preload" href="/blog/assets/css/0.styles.093df223.css" as="style"><link rel="preload" href="/blog/assets/js/app.22a76c6c.js" as="script"><link rel="preload" href="/blog/assets/js/2.0274c0be.js" as="script"><link rel="preload" href="/blog/assets/js/53.0cedcfdf.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.46022215.js"><link rel="prefetch" href="/blog/assets/js/11.5e5b0273.js"><link rel="prefetch" href="/blog/assets/js/12.48b1baa1.js"><link rel="prefetch" href="/blog/assets/js/13.34e67170.js"><link rel="prefetch" href="/blog/assets/js/14.d1c9ae70.js"><link rel="prefetch" href="/blog/assets/js/15.1a9bc17f.js"><link rel="prefetch" href="/blog/assets/js/16.f7f047c1.js"><link rel="prefetch" href="/blog/assets/js/17.c0c11a1f.js"><link rel="prefetch" href="/blog/assets/js/18.d3f7c7fc.js"><link rel="prefetch" href="/blog/assets/js/19.d1818d68.js"><link rel="prefetch" href="/blog/assets/js/20.28829068.js"><link rel="prefetch" href="/blog/assets/js/21.a6041081.js"><link rel="prefetch" href="/blog/assets/js/22.879b8fbd.js"><link rel="prefetch" href="/blog/assets/js/23.38093c24.js"><link rel="prefetch" href="/blog/assets/js/24.59a484b7.js"><link rel="prefetch" href="/blog/assets/js/25.48a40b9b.js"><link rel="prefetch" href="/blog/assets/js/26.7a471117.js"><link rel="prefetch" href="/blog/assets/js/27.546be362.js"><link rel="prefetch" href="/blog/assets/js/28.c1eb6c3e.js"><link rel="prefetch" href="/blog/assets/js/29.d0e8f606.js"><link rel="prefetch" href="/blog/assets/js/3.45e8260f.js"><link rel="prefetch" href="/blog/assets/js/30.5adc7c4c.js"><link rel="prefetch" href="/blog/assets/js/31.aecc3dd4.js"><link rel="prefetch" href="/blog/assets/js/32.ad8c8c73.js"><link rel="prefetch" href="/blog/assets/js/33.dd43d770.js"><link rel="prefetch" href="/blog/assets/js/34.c3ce5b32.js"><link rel="prefetch" href="/blog/assets/js/35.e4ee23e1.js"><link rel="prefetch" href="/blog/assets/js/36.344e8d96.js"><link rel="prefetch" href="/blog/assets/js/37.8e61c519.js"><link rel="prefetch" href="/blog/assets/js/38.fcc47c26.js"><link rel="prefetch" href="/blog/assets/js/39.a85f3f52.js"><link rel="prefetch" href="/blog/assets/js/4.d4b9bbeb.js"><link rel="prefetch" href="/blog/assets/js/40.1cd9b04f.js"><link rel="prefetch" href="/blog/assets/js/41.09774c78.js"><link rel="prefetch" href="/blog/assets/js/42.12c67dcb.js"><link rel="prefetch" href="/blog/assets/js/43.ef368b2e.js"><link rel="prefetch" href="/blog/assets/js/44.da9b2480.js"><link rel="prefetch" href="/blog/assets/js/45.a22b1704.js"><link rel="prefetch" href="/blog/assets/js/46.dcdba70d.js"><link rel="prefetch" href="/blog/assets/js/47.23918cdb.js"><link rel="prefetch" href="/blog/assets/js/48.8e922edb.js"><link rel="prefetch" href="/blog/assets/js/49.382a292b.js"><link rel="prefetch" href="/blog/assets/js/5.cff55483.js"><link rel="prefetch" href="/blog/assets/js/50.3c487deb.js"><link rel="prefetch" href="/blog/assets/js/51.21a3f87c.js"><link rel="prefetch" href="/blog/assets/js/52.885195bf.js"><link rel="prefetch" href="/blog/assets/js/54.dc4e8469.js"><link rel="prefetch" href="/blog/assets/js/6.0f60e96d.js"><link rel="prefetch" href="/blog/assets/js/7.b0a07d36.js"><link rel="prefetch" href="/blog/assets/js/8.28e502e5.js"><link rel="prefetch" href="/blog/assets/js/9.396a5252.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.093df223.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">zchzh的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/note/" class="nav-link">
  笔记
</a></div><div class="nav-item"><a href="/blog/interview/" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="/blog/share/" class="nav-link router-link-active">
  分享
</a></div><div class="nav-item"><a href="/blog/other/" class="nav-link">
  其他
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/puck-ini" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://puck-ini.github.io/blog/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/note/" class="nav-link">
  笔记
</a></div><div class="nav-item"><a href="/blog/interview/" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="/blog/share/" class="nav-link router-link-active">
  分享
</a></div><div class="nav-item"><a href="/blog/other/" class="nav-link">
  其他
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/puck-ini" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://puck-ini.github.io/blog/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>分享</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/share/分布式锁.html" class="active sidebar-link">分布式锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#什么是分布式锁" class="sidebar-link">什么是分布式锁</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#分布式锁的特点" class="sidebar-link">分布式锁的特点</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#分布式锁的实现方式" class="sidebar-link">分布式锁的实现方式</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#数据库分布式锁" class="sidebar-link">数据库分布式锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#悲观锁" class="sidebar-link">悲观锁</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#乐观锁" class="sidebar-link">乐观锁</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#redis-分布式锁" class="sidebar-link">Redis 分布式锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#set" class="sidebar-link">set</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#setnx" class="sidebar-link">setnx</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#set-nx-px" class="sidebar-link">set nx px</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#唯一值" class="sidebar-link">唯一值</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#lua-脚本" class="sidebar-link">Lua 脚本</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#重入锁" class="sidebar-link">重入锁</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#阻塞等待" class="sidebar-link">阻塞等待</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#定时任务" class="sidebar-link">定时任务</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#redisson" class="sidebar-link">Redisson</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#zookeeper-分布式锁" class="sidebar-link">Zookeeper 分布式锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#简单实现" class="sidebar-link">简单实现</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#java-代码实现" class="sidebar-link">Java 代码实现</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#测试" class="sidebar-link">测试</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#curator-使用" class="sidebar-link">Curator 使用</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#多节点分布式锁" class="sidebar-link">多节点分布式锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#redlock" class="sidebar-link">RedLock</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#zookeeper-集群" class="sidebar-link">Zookeeper 集群</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#分布式锁可靠性" class="sidebar-link">分布式锁可靠性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#网络延迟和进程暂停问题" class="sidebar-link">网络延迟和进程暂停问题</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#时钟跳跃问题" class="sidebar-link">时钟跳跃问题</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#多节点分布式锁对比" class="sidebar-link">多节点分布式锁对比</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#相关问题" class="sidebar-link">相关问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#redlock-中为什么必须是毫无关联的节点-为什么集群和主从模式下的-redis-不行。" class="sidebar-link">RedLock 中为什么必须是毫无关联的节点，为什么集群和主从模式下的 Redis 不行。</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#为什么-zookeeper-主从集群可以保证在选主之后分布式锁的可靠性-而-redis-不行" class="sidebar-link">为什么 Zookeeper 主从集群可以保证在选主之后分布式锁的可靠性，而 Redis 不行</a></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#网络延迟和进程暂停问题是如何导致-zookeeper-分布式锁失效的" class="sidebar-link">网络延迟和进程暂停问题是如何导致 Zookeeper 分布式锁失效的</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/share/分布式锁.html#总结" class="sidebar-link">总结</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="分布式锁"><a href="#分布式锁" class="header-anchor">#</a> 分布式锁</h1> <h2 id="什么是分布式锁"><a href="#什么是分布式锁" class="header-anchor">#</a> 什么是分布式锁</h2> <p>单机情况下，当多线程操作共享变量时，为了保证数据的一致性，同一时间只能有一个线程在操作该变量，这时候就得上锁。</p> <p>当在集群这种多机的情况时，单机上的锁无法被其他机器上的线程获取，也就是说不能保证在同一时间只能有一个线程操作该变量，这个时候就得引入一个中间层，保证多机情况下每一个线程都能访问到锁，这就是分布式锁。</p> <h2 id="分布式锁的特点"><a href="#分布式锁的特点" class="header-anchor">#</a> 分布式锁的特点</h2> <p>分布式锁最重要的特点是互斥性</p> <ul><li>互斥性：和我们本地锁一样互斥性是最基本，但是分布式锁需要保证在不同节点的不同线程的互斥。</li> <li>可重入性：同一个节点上的同一个线程如果获取了锁之后那么也可以再次获取这个锁。</li> <li>锁超时：和本地锁一样支持锁超时，防止死锁。</li> <li>高效，高可用：加锁和解锁需要高效，同时也需要保证高可用防止分布式锁失效，可以增加降级。</li> <li>支持阻塞和非阻塞：和ReentrantLock一样支持lock和trylock以及tryLock(long timeOut)。</li> <li>支持公平锁和非公平锁(可选)：公平锁的意思是按照请求加锁的顺序获得锁，非公平锁就相反是无序的。这个一般来说实现的比较少。</li></ul> <h2 id="分布式锁的实现方式"><a href="#分布式锁的实现方式" class="header-anchor">#</a> 分布式锁的实现方式</h2> <ul><li>数据库</li> <li>Redis</li> <li>Zookeeper</li> <li>...</li></ul> <h2 id="数据库分布式锁"><a href="#数据库分布式锁" class="header-anchor">#</a> 数据库分布式锁</h2> <h3 id="悲观锁"><a href="#悲观锁" class="header-anchor">#</a> 悲观锁</h3> <p>for update 获取行锁</p> <h3 id="乐观锁"><a href="#乐观锁" class="header-anchor">#</a> 乐观锁</h3> <p>version 版本控制</p> <h2 id="redis-分布式锁"><a href="#redis-分布式锁" class="header-anchor">#</a> Redis 分布式锁</h2> <p>锁要保证互斥性，分布式锁也不例外，Redis 中可以使用键值对保存锁，通过 key 的唯一性在同一时间确保只能让一个客户端获取到锁。</p> <h3 id="set"><a href="#set" class="header-anchor">#</a> set</h3> <p>保证互斥性可以直接使用 set 命令，因为 Redis 是单线程处理命令，所以不会造成多个客户端同时获取到锁。首先约定好 key 值，这样所有客户端都能访问到锁，value 值为0表示未获取到锁，1表示获取到锁。当有客户端试图获取锁时先判断值是否为0，为0则将 value 设置为1表示已有客户端获取到锁，其他客户端在获取锁时就无法获取成功。</p> <p><strong>存在的问题：</strong></p> <p>虽然 Redis 单线程处理命令可以保证只有一个客户端获取到锁，但是客户端方面因为要经过判断和设置值，这两个操作无法保证原子性，所以会导致多个客户端获取到锁。</p> <h3 id="setnx"><a href="#setnx" class="header-anchor">#</a> setnx</h3> <p>setnx 的意思是 set if not exist。这个操作在 Redis 2.6.12 版本及之后支持，该命令会在设置键值对时判断库中是否存在，如果不存在就会创建键值对，设置成功会返回1，失败会返回0，这样判断和加锁的操作就可以直接使用 setnx 命令。</p> <p><strong>存在问题：</strong></p> <p>如果获取到锁的客户端崩溃了就会导致锁一直不能被释放，其他客户端也无法加锁。</p> <h3 id="set-nx-px"><a href="#set-nx-px" class="header-anchor">#</a> set nx px</h3> <p>根据上述问题可以使用 set nx px 命令（2.6.12），该命令在保证 setnx 的功能同时可以对 key 设置过时间。这样获取到锁的客户端崩溃了也不会一直持有锁导致其他客户端无法获取锁。</p> <p><strong>存在问题：</strong></p> <p>设置了过期时间之后锁可能会被误删，例如客户端 A 获取到锁之后处理业务时间超时导致锁过期了，这个时候客户端 B 获取到锁还没进行业务处理时，客户端 A 刚好处理完将锁删了就会导致客户端 B 获取到的锁被误删。</p> <h3 id="唯一值"><a href="#唯一值" class="header-anchor">#</a> 唯一值</h3> <p>为了防止锁被误删，可以将锁的 value 设置成客户端的唯一标识，这样在删除锁是先判断唯一值是否是自己上的锁，即谁上的锁谁才能删除。</p> <p><strong>存在问题：</strong></p> <p>原本的删除锁只是一个操作，是原子性的，但是这次多了判断之后就会导致删除锁也变成不是原子性的。</p> <h3 id="lua-脚本"><a href="#lua-脚本" class="header-anchor">#</a> Lua 脚本</h3> <p>Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p> <p>Redis 在执行 lua 脚本时是原子性的，不会被其他请求打断。</p> <p>获取锁：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&quot;if redis.call('setnx',KEYS[1],ARGV[1])==1 then\n&quot; +
&quot;    if redis.call('get',KEYS[1])==ARGV[1] then\n&quot; +
&quot;        return redis.call('expire',KEYS[1],ARGV[2])\n&quot; +
&quot;    else\n&quot; +
&quot;        return 0\n&quot; +
&quot;    end\n&quot; +
&quot;else\n&quot; +
&quot;end&quot;;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>删除锁：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 释放锁 比较value是否相等，避免误释放
&quot;if redis.call(\&quot;get\&quot;,KEYS[1]) == ARGV[1] then\n&quot; +
&quot;    return redis.call(\&quot;del\&quot;,KEYS[1])\n&quot; +
&quot;else\n&quot; +
&quot;    return 0\n&quot; +
&quot;end&quot;;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>存在问题：</strong></p> <p>锁不可重入，不支持阻塞等待，业务处理时间大于锁过期时间无法续期。</p> <h3 id="重入锁"><a href="#重入锁" class="header-anchor">#</a> 重入锁</h3> <p>可重入锁的最大作用是防止死锁。重入多少次就得释放多少次</p> <p>不可重入锁例子。test1() 重复加锁会导致死锁。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpinLock</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> owner <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 将当前线程设置成锁
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>owner<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 释放锁
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> unlock <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        owner<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * SpinLock 是不可重入锁， 该方法会重复加锁会产生死锁
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// test2 方法也使用了 SpinLock 加锁</span>
            <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;test2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpinLock</span> spinLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpinLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        spinLock<span class="token punctuation">.</span><span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>解决不可重入锁可以增加一个计数，在重复加锁时计数加1，释放锁时计数键1</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpinLock1</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> owner <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> owner<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>owner<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> unlock <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>current <span class="token operator">==</span> owner<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                count<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                owner<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;test2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpinLock1</span> spinLock1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpinLock1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        spinLock1<span class="token punctuation">.</span><span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h3 id="阻塞等待"><a href="#阻塞等待" class="header-anchor">#</a> 阻塞等待</h3> <p>可以在一个循环中不停的获取锁，但是这样效率会很低。</p> <h3 id="定时任务"><a href="#定时任务" class="header-anchor">#</a> 定时任务</h3> <p>解决业务处理时间大于锁过期时间的问题可以设置比较大的锁过期时间，但是这样无法做到将问题根本解决。这个时候可以使用一个定时任务在锁快过期时为锁重新设置过期时间。</p> <h3 id="redisson"><a href="#redisson" class="header-anchor">#</a> Redisson</h3> <blockquote><p>Redisson是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务。其中包括(BitSet, Set, Multimap, SortedSet, Map, List, Queue, BlockingQueue, Deque, BlockingDeque, Semaphore, Lock, AtomicLong, CountDownLatch, Publish / Subscribe, Bloom filter, Remote service, Spring cache, Executor service, Live Object service, Scheduler service) Redisson提供了使用Redis的最简单和最便捷的方法。Redisson的宗旨是促进使用者对Redis的关注分离（Separation of Concern），从而让使用者能够将精力更集中地放在处理业务逻辑上。</p></blockquote> <p>简而言之 Redisson 是一个 Java 实现的操作 Redis 的客户端。使用 Redisson 提供的分布式锁功能可以避免上述所说的所有问题。</p> <h4 id="唯一值-2"><a href="#唯一值-2" class="header-anchor">#</a> 唯一值</h4> <p>使用的是UUID + 当前线程Id</p> <p><img src="img/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/image-20210121150056729.png" alt="image-20210121150056729"></p> <h4 id="加锁-lua-脚本。"><a href="#加锁-lua-脚本。" class="header-anchor">#</a> 加锁 lua 脚本。</h4> <p>Redisson 实现的分布式锁使用的是 Redis hash 数据类型，key 保存锁名，field 保存客户端的唯一值，value 表示重入次数。</p> <blockquote><p>如果锁不存在设置锁，同时设置锁的过期时间（internalLockLeaseTime），return</p> <p>如果锁存在，判断是否属于自己加的锁，如果是则将值加1，同时将重新设置过期时间（重入锁）。</p> <p>如果锁存在并且不属于自己加的锁则返回锁目前剩余的过期时间。</p></blockquote> <p><img src="img/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/image-20210121150034511.png" alt="image-20210121150034511"></p> <h4 id="解锁-lua-脚本。"><a href="#解锁-lua-脚本。" class="header-anchor">#</a> 解锁 lua 脚本。</h4> <blockquote><p>如果锁不存在，publish 发送锁已经解锁的消息。</p> <p>如果锁存在，判断是否属于自己创建的锁，不属于自己的锁直接返回不处理。</p> <p>如果属于自己的锁，将值减1并返回，判断该值如果大于0，重新设置锁的过期时间，否则删除该锁并发布锁已经解锁的消息。</p></blockquote> <p><img src="img/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/image-20210121145836082.png" alt="image-20210121145836082"></p> <p>可以看到解锁脚本中有一个发布事件的处理，这个发布事件的作用主要是通知其他正在阻塞获取锁的客户端锁已经被释放，可以再次获取锁。</p> <h4 id="阻塞等待-2"><a href="#阻塞等待-2" class="header-anchor">#</a> 阻塞等待</h4> <p>Redisson 的阻塞等待使用了 Redis 的 pub/sub 机制（发布订阅机制）。当客户端未获取到锁时会订阅一个频道等待获取锁的客户端释放锁时发布释放锁事件。</p> <p><img src="img/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/image-20210412135634196.png" alt="image-20210412135634196"></p> <h4 id="锁续期。"><a href="#锁续期。" class="header-anchor">#</a> 锁续期。</h4> <p>续期只有在获取锁时不设置等待时间和过期时间才会自动续期，当客户端获取到锁时会开启一个定时任务续期。Redisson 锁默认情况下锁的过期时间为30秒，每10秒给锁续期的时间也为30秒。</p> <p><img src="img/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/image-20210407153223447.png" alt="image-20210407153223447"></p> <h2 id="zookeeper-分布式锁"><a href="#zookeeper-分布式锁" class="header-anchor">#</a> Zookeeper 分布式锁</h2> <p>Zookeeper 中数据单元为节点，一个节点的名字是在同一节点下是唯一的，在获取锁时创建节点，释放锁时删除该节点，这就保证了多个客户端在获取锁时保证只有一个客户端获取到锁。</p> <h3 id="简单实现"><a href="#简单实现" class="header-anchor">#</a> 简单实现</h3> <p>通过 create 指令创建节点，创建成功则获取到锁。但是这里面有一个问题，即客户端在创建成功锁之后如果崩溃了就无法释放锁。</p> <h4 id="获取锁的客户端崩溃问题"><a href="#获取锁的客户端崩溃问题" class="header-anchor">#</a> 获取锁的客户端崩溃问题</h4> <p>为了解决这个问题我们可以使用 Zookeeper 提供的临时节点。这里简单介绍下 Zookeeper  节点类型。</p> <p>Zookeeper 包含以下节点类型：</p> <ul><li>永久节点</li> <li>永久顺序节点</li> <li>临时节点</li> <li>临时顺序节点</li></ul> <p>永久节点：即使 Zookeeper 或者客户端断线都不会删除的节点，除非客户端主动删除。</p> <p>临时节点：Zookeeper 断开连接或者客户端断开连接都会把临时节点删除。（只会删除断开连接的客户端创建的临时节点）</p> <p>顺序节点：给创建的节点一个递增的编号。编号添加在节点名字后。</p> <p>这样客户端在获取锁创建节点时创建临时节点就好了，即使加锁客户端崩溃也不会造成无法释放锁的问题。</p> <h4 id="未获取到锁客户端阻塞等待问题"><a href="#未获取到锁客户端阻塞等待问题" class="header-anchor">#</a> 未获取到锁客户端阻塞等待问题</h4> <p>解决了释放锁的问题，我们来看看未获取到锁的客户端该如何阻塞等待。</p> <p>未获取锁的客户端可以通过循环获取的方式不停的访问 Zookeeper 中的锁节点获取锁，但是这样效率很低，这个时候可以使用 Zookeeper 提供的 watch 机制实现。</p> <p>watch 机制：</p> <p>客户端可以监听任意节点的数据变化，当监听的节点数据发生变化时，zookeeper server 会发送事件通知监听该节点的所有客户端。</p> <p>通过 watch 机制未获取锁的客户端就可以监听锁节点的变化，当锁节点被获取锁的客户端释放时，Zookeeper 就会通知到所有监听该节点的客户端再次进行获取锁的操作。</p> <h4 id="羊群效应"><a href="#羊群效应" class="header-anchor">#</a> 羊群效应</h4> <p>当争抢锁的客户端很多时，因为同一时间只能一个客户端获取锁，当释放锁时 Zookeeper 需要通知大量的客户端会导致性能下降。这个时候可以同时上述的顺序节点解决。</p> <p>每一个客户端都在约定好的节点下创建临时顺序的锁节点，创建后判断是否是序号最小的节点，是则获取锁成功，不是则监听比自己创建的节点序号小的前一个节点，这样就不会造成大量的客户端监听同一个节点导致的 Zookeeper 性能下降问题。</p> <h3 id="java-代码实现"><a href="#java-代码实现" class="header-anchor">#</a> Java 代码实现</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZkLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> LOCK_NODE <span class="token operator">=</span> <span class="token string">&quot;/zklock&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> SEPARATOR <span class="token operator">=</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> LOCK_NAME <span class="token operator">=</span> <span class="token string">&quot;lock&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">ZkClient</span> zkClient<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> preNode<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> currentNode<span class="token punctuation">;</span>

    <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ZkLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> address<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        zkClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZkClient</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
        zkClient<span class="token punctuation">.</span><span class="token function">setZkSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SerializableSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">ZkLock</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>zkClient<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>LOCK_NODE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                zkClient<span class="token punctuation">.</span><span class="token function">createPersistent</span><span class="token punctuation">(</span>LOCK_NODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">waitUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> rootNode <span class="token operator">=</span> LOCK_NODE <span class="token operator">+</span> SEPARATOR<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>currentNode<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>currentNode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            currentNode <span class="token operator">=</span> zkClient<span class="token punctuation">.</span><span class="token function">createEphemeralSequential</span><span class="token punctuation">(</span>rootNode<span class="token punctuation">,</span> LOCK_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> children <span class="token operator">=</span> zkClient<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span>LOCK_NODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> minNode <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isEquals <span class="token operator">=</span> currentNode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>rootNode <span class="token operator">+</span> minNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isEquals<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">binarySearch</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> currentNode<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>rootNode<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> lastNodeChild <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            preNode <span class="token operator">=</span> rootNode <span class="token operator">+</span> lastNodeChild<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> isEquals<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">waitUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">IZkDataListener</span> listener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IZkDataListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDataChange</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDataDeleted</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        zkClient<span class="token punctuation">.</span><span class="token function">subscribeDataChanges</span><span class="token punctuation">(</span>preNode<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>zkClient<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>preNode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        zkClient<span class="token punctuation">.</span><span class="token function">subscribeDataChanges</span><span class="token punctuation">(</span>preNode<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>zkClient<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            zkClient<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>currentNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            zkClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br></div></div><h3 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZkTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> NUM <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> LATCH <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>NUM<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> NUM<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span> i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TestRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            LATCH<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TestRunnable</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZkLock</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                LATCH<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; : lock success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h3 id="curator-使用"><a href="#curator-使用" class="header-anchor">#</a> Curator 使用</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CuratorLockTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> NUM <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> LATCH <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>NUM<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> LOCK_NODE <span class="token operator">=</span> <span class="token string">&quot;/zklock&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> NUM<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TestRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            LATCH<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TestRunnable</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                LATCH<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">RetryPolicy</span> retryPolicy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExponentialBackoffRetry</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CuratorFramework</span> client <span class="token operator">=</span> <span class="token class-name">CuratorFrameworkFactory</span><span class="token punctuation">.</span><span class="token function">newClient</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2181&quot;</span><span class="token punctuation">,</span> retryPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">InterProcessMutex</span> mutex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InterProcessMutex</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> LOCK_NODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mutex<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; : lock success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    mutex<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h2 id="多节点分布式锁"><a href="#多节点分布式锁" class="header-anchor">#</a> 多节点分布式锁</h2> <p>上述的分布式锁都是在单机情况下的锁，多节点分布式锁是为了保证锁的高可用而存在的。</p> <h3 id="redlock"><a href="#redlock" class="header-anchor">#</a> RedLock</h3> <p>Redlock 是 Redis 作者 antirez 提出的算法，在 Redis 的分布式环境中，我们假设有N个Redis master。这些节点<strong>完全互相独立，不存在主从复制或者其他集群协调机制。当且仅当从大多数（N/2+1）的 Redis 节点都取到锁，并且使用的时间小于锁失效时间时，锁才算获取成功</strong>。</p> <blockquote><p>Redlock 的方案不再需要部署从库和哨兵实例，只部署主库，但主库要部署多个，官方推荐至少 5 个实例。</p></blockquote> <h4 id="redlock-流程"><a href="#redlock-流程" class="header-anchor">#</a> RedLock 流程</h4> <ol><li>客户端先获取「当前时间戳T1」</li> <li>客户端依次向这 5 个 Redis 实例发起加锁请求，且每个请求会设置超时时间（毫秒级，要远小于锁的有效时间，例如过期时间是10秒，请求超时时间可以为5-50毫秒），如果某一个实例加锁失败（包括网络超时、锁被其它人持有等各种异常情况），就立即向下一个 Redis 实例申请加锁</li> <li>如果客户端从 &gt;=3 个（大多数，N / 2 + 1）以上 Redis 实例加锁成功，则再次获取「当前时间戳T2」，如果 T2 - T1 &lt; 锁的过期时间，此时，认为客户端加锁成功，否则认为加锁失败</li> <li>加锁成功，去操作共享资源</li> <li>加锁失败，向「全部节点」发起释放锁请求</li></ol> <h3 id="zookeeper-集群"><a href="#zookeeper-集群" class="header-anchor">#</a> Zookeeper 集群</h3> <p>单点的 Zookeeper 提供的是不可靠的分布式锁服务，毕竟 Zookeeper 崩了客户端就无法获取到锁业务也无法正常完成。为了保证可靠可以使用集群。</p> <p>Zookeeper 集群下的分布式锁不需要进行额外的操作，只需要正常部署 Zookeeper 集群即可。Zookeeper 本身通过 Zab 协议保证了数据的一致性。</p> <blockquote><p>Zab协议 的全称是 Zookeeper Atomic Broadcast （Zookeeper原子广播）。保证了集群中各个 server 之间的同步。Zab 协议借鉴了 Paxos 协议，是专为 Zookeeper 设计的支持崩溃恢复原子消息广播算法。</p></blockquote> <h2 id="分布式锁可靠性"><a href="#分布式锁可靠性" class="header-anchor">#</a> 分布式锁可靠性</h2> <p>首先单个节点就是不安全的，我们看看多节点的分布式锁。</p> <p>我们首先来看看分布式系统常见的问题：</p> <ul><li>N：Network Delay，网络延迟</li></ul> <p>TCP 虽然保证了传输的可靠性，但是网络延迟是无法避免的</p> <ul><li>P：Process Pause，进程暂停</li></ul> <p>例如 Java 中的 GC （垃圾回收）</p> <ul><li>C：Clock Drift，时钟跳跃</li></ul> <p>使用 NTP 协议将本地设备时间与专门的时间服务器对其，造成的结果是设备的本地时间突然向前或向后跳跃。</p> <h3 id="网络延迟和进程暂停问题"><a href="#网络延迟和进程暂停问题" class="header-anchor">#</a> 网络延迟和进程暂停问题</h3> <ul><li>Redis</li></ul> <p>在发生网络延迟或者进程暂停的时候，如果问题发生在 1 到 3 步之间，可以看到 RedLock 的第三步就能检测出来，这样会判断加锁失败。如果发生在之后，即客户端已经拿到锁了，可能会导致客户端去操作共享资源但是锁已经失效，所以这时候可以说是不可靠的。</p> <ul><li>Zookeeper</li></ul> <p>Zookeeper 面对这两个问题同样是不可靠的，因为无论是网络延迟还是进程暂停都会导致 Zookeeper 集群以为客户端已经断开连接导致删除临时的锁节点。</p> <h3 id="时钟跳跃问题"><a href="#时钟跳跃问题" class="header-anchor">#</a> 时钟跳跃问题</h3> <ul><li>Redis</li></ul> <p>我们再看看时钟跳跃。假设有 ABCDE 5个 Redis 实例，客户端1在 ABC 上加锁成功，这个时候 C 发生了时钟向前跳跃导致锁提前过期，这个时候客户端 2 在 CDE 上加锁成功，这样就会出现问题。所以 RedLock 是可以看作不安全的。虽然时钟跳跃可以在一定程度上避免，例如不要手动修改时钟、通过恰当的运维保证机器不会出现大幅度的跳跃（每次通过微小的调整来完成）。</p> <ul><li>Zookeeper</li></ul> <p>Zookeeper 的分布式锁没有过期时间的概念，所以对于这个问题 Zookeeper 的分布式锁是可靠的。</p> <h3 id="多节点分布式锁对比"><a href="#多节点分布式锁对比" class="header-anchor">#</a> 多节点分布式锁对比</h3> <p>因此在需要保证可靠服务的场景需要使用分布式锁是尽量不要使用 Redis 做分布式锁，虽然时钟跳跃可以人为的在一定程度上避免，但是这个问题还是不能保证一定能解决，这个时候使用 Zookeeper 作为分布式锁会是更好的选择。（Zookeeper 也是无法解决网络延迟和进程暂停的问题，但是可以解决时钟跳跃的问题）</p> <h2 id="相关问题"><a href="#相关问题" class="header-anchor">#</a> 相关问题</h2> <h3 id="redlock-中为什么必须是毫无关联的节点-为什么集群和主从模式下的-redis-不行。"><a href="#redlock-中为什么必须是毫无关联的节点-为什么集群和主从模式下的-redis-不行。" class="header-anchor">#</a> RedLock 中为什么必须是毫无关联的节点，为什么集群和主从模式下的 Redis 不行。</h3> <p>Redis 集群是将多个节点当成一个节点使用，即将所有的数据分片保存在不同的节点中，所以在 Redis 集群中无法使用 RedLock。</p> <p>Redis 主从模式下的节点只有主节点能进行写操作，同步会将写操作同步到其他节点，同样无法使用 RedLock。因为 RedLock 要在不同的节点上执行加锁操作。</p> <h3 id="为什么-zookeeper-主从集群可以保证在选主之后分布式锁的可靠性-而-redis-不行"><a href="#为什么-zookeeper-主从集群可以保证在选主之后分布式锁的可靠性-而-redis-不行" class="header-anchor">#</a> 为什么 Zookeeper 主从集群可以保证在选主之后分布式锁的可靠性，而 Redis 不行</h3> <p>因为 Zookeeper 的数据复制是同步的，Redis 是异步的。</p> <p>Redis 主节点加锁之后还未同步到从节点，此时主节点崩溃导致从节点没同步到锁的数据，当从节点升级为主节点之后其他客户端可以加锁。</p> <p>而 Zookeeper 通过 Zab 协议，客户端发送加锁请求时，主节点不会马上加锁返回，而是将请求封装成 purpose 发送给从节点，当有半数的从节点响应 purpose时，主节点再次发送提交的信息给从节点，同时将加锁操作在主节点上执行并返回给客户端，整个操作类似于2PC。所以在主节点崩溃之后，即使从节点升级为主节点仍然具备锁的信息，其他客户端加锁会失败。</p> <h3 id="网络延迟和进程暂停问题是如何导致-zookeeper-分布式锁失效的"><a href="#网络延迟和进程暂停问题是如何导致-zookeeper-分布式锁失效的" class="header-anchor">#</a> 网络延迟和进程暂停问题是如何导致 Zookeeper 分布式锁失效的</h3> <p>Zookeeper 中的 watch 机制其实是使用长连接实现的，客户端连接 Zookeeper 服务器后跟服务器保持一个长连接，同时会一直发送心跳到服务器，如果服务器在一定时间内未收到心跳就会认为该客户端已经断开连接，从而将该客户端创建的所有临时节点删除。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>这里主要介绍了 Redis 和 Zookeeper 的分布式锁相关内容，对于分布式锁，Redis 分布式锁效率更高，而 Zookeeper 分布式锁可靠性更高，在后续的使用中如果只是使用单节点分布式锁 Redis 和 Zookeeper 都可以使用，如果是多节点的需要确保分布式锁的可靠性的建议使用 Zookeeper 实现的分布式锁。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.22a76c6c.js" defer></script><script src="/blog/assets/js/2.0274c0be.js" defer></script><script src="/blog/assets/js/53.0cedcfdf.js" defer></script>
  </body>
</html>
